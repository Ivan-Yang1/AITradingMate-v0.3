"""äº¤æ˜“è„šæœ¬æœåŠ¡ - AIç”ŸæˆPineScript/Pythonè„šæœ¬å¹¶ç›‘æ§æ‰§è¡Œ"""
import logging
from typing import Dict, List, Optional, Any
from datetime import datetime
import json
import re

logger = logging.getLogger(__name__)


class ScriptService:
    """äº¤æ˜“è„šæœ¬æœåŠ¡"""
    
    # æ”¯æŒçš„è„šæœ¬ç±»å‹
    SCRIPT_TYPES = {
        'pinescript': {
            'name': 'PineScript',
            'extension': '.pine',
            'description': 'TradingView PineScriptè„šæœ¬',
        },
        'python': {
            'name': 'Python',
            'extension': '.py',
            'description': 'Pythonäº¤æ˜“è„šæœ¬',
        }
    }
    
    # å¸¸ç”¨æŠ€æœ¯æŒ‡æ ‡æ¨¡æ¿
    INDICATOR_TEMPLATES = {
        'golden_cross': {
            'name': 'é‡‘å‰',
            'description': 'çŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿',
            'condition': 'MAçŸ­æœŸ > MAé•¿æœŸ ä¸” å‰ä¸€æ—¥MAçŸ­æœŸ < å‰ä¸€æ—¥MAé•¿æœŸ',
        },
        'death_cross': {
            'name': 'æ­»å‰',
            'description': 'çŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿',
            'condition': 'MAçŸ­æœŸ < MAé•¿æœŸ ä¸” å‰ä¸€æ—¥MAçŸ­æœŸ > å‰ä¸€æ—¥MAé•¿æœŸ',
        },
        'macd_golden_cross': {
            'name': 'MACDé‡‘å‰',
            'description': 'MACDçº¿ä¸Šç©¿ä¿¡å·çº¿',
            'condition': 'MACD > Signal ä¸” å‰ä¸€æ—¥MACD < å‰ä¸€æ—¥Signal',
        },
        'macd_death_cross': {
            'name': 'MACDæ­»å‰',
            'description': 'MACDçº¿ä¸‹ç©¿ä¿¡å·çº¿',
            'condition': 'MACD < Signal ä¸” å‰ä¸€æ—¥MACD > å‰ä¸€æ—¥Signal',
        },
        'rsi_oversold': {
            'name': 'RSIè¶…å–',
            'description': 'RSIä½äº30',
            'condition': 'RSI < 30',
        },
        'rsi_overbought': {
            'name': 'RSIè¶…ä¹°',
            'description': 'RSIé«˜äº70',
            'condition': 'RSI > 70',
        },
        'kdj_golden_cross': {
            'name': 'KDJé‡‘å‰',
            'description': 'Kçº¿ä¸Šç©¿Dçº¿',
            'condition': 'K > D ä¸” å‰ä¸€æ—¥K < å‰ä¸€æ—¥D',
        },
        'volume_breakout': {
            'name': 'æ”¾é‡çªç ´',
            'description': 'æˆäº¤é‡è¶…è¿‡20æ—¥å‡é‡2å€',
            'condition': 'Volume > MA20_Volume * 2',
        },
        'price_breakout': {
            'name': 'ä»·æ ¼çªç ´',
            'description': 'æ”¶ç›˜ä»·çªç ´20æ—¥é«˜ç‚¹',
            'condition': 'Close > 20æ—¥æœ€é«˜ä»·',
        },
        'boll_lower': {
            'name': 'è§¦åŠå¸ƒæ—ä¸‹è½¨',
            'description': 'ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨',
            'condition': 'Close <= BOLLä¸‹è½¨',
        },
        'boll_upper': {
            'name': 'è§¦åŠå¸ƒæ—ä¸Šè½¨',
            'description': 'ä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨',
            'condition': 'Close >= BOLLä¸Šè½¨',
        },
    }
    
    def __init__(self):
        # å­˜å‚¨æ´»è·ƒçš„ç›‘æ§ä»»åŠ¡
        self.active_monitors: Dict[str, Dict] = {}
        logger.info("ScriptService initialized")
    
    def parse_user_intent(self, user_input: str) -> Dict[str, Any]:
        """è§£æç”¨æˆ·æ„å›¾ï¼Œæå–ç›‘æ§æ¡ä»¶"""
        intent = {
            'indicators': [],
            'conditions': [],
            'timeframe': 'daily',
            'notification_type': 'alert',
        }
        
        # æ£€æµ‹æ—¶é—´å‘¨æœŸ
        if any(kw in user_input for kw in ['åˆ†é’Ÿ', '5åˆ†é’Ÿ', '15åˆ†é’Ÿ', '30åˆ†é’Ÿ', '60åˆ†é’Ÿ']):
            if '5åˆ†é’Ÿ' in user_input:
                intent['timeframe'] = '5min'
            elif '15åˆ†é’Ÿ' in user_input:
                intent['timeframe'] = '15min'
            elif '30åˆ†é’Ÿ' in user_input:
                intent['timeframe'] = '30min'
            elif '60åˆ†é’Ÿ' in user_input or '1å°æ—¶' in user_input:
                intent['timeframe'] = '60min'
        elif any(kw in user_input for kw in ['å‘¨çº¿', 'å‘¨']):
            intent['timeframe'] = 'weekly'
        elif any(kw in user_input for kw in ['æœˆçº¿', 'æœˆ']):
            intent['timeframe'] = 'monthly'
        
        # æ£€æµ‹æŒ‡æ ‡å’Œæ¡ä»¶
        if 'é‡‘å‰' in user_input:
            if 'MACD' in user_input.upper():
                intent['indicators'].append('macd_golden_cross')
                intent['conditions'].append('MACDé‡‘å‰')
            elif 'KDJ' in user_input.upper():
                intent['indicators'].append('kdj_golden_cross')
                intent['conditions'].append('KDJé‡‘å‰')
            else:
                intent['indicators'].append('golden_cross')
                intent['conditions'].append('å‡çº¿é‡‘å‰')
        
        if 'æ­»å‰' in user_input:
            if 'MACD' in user_input.upper():
                intent['indicators'].append('macd_death_cross')
                intent['conditions'].append('MACDæ­»å‰')
            else:
                intent['indicators'].append('death_cross')
                intent['conditions'].append('å‡çº¿æ­»å‰')
        
        if any(kw in user_input for kw in ['è¶…å–', 'RSIä½äº', 'RSI<']):
            intent['indicators'].append('rsi_oversold')
            intent['conditions'].append('RSIè¶…å–')
        
        if any(kw in user_input for kw in ['è¶…ä¹°', 'RSIé«˜äº', 'RSI>']):
            intent['indicators'].append('rsi_overbought')
            intent['conditions'].append('RSIè¶…ä¹°')
        
        if any(kw in user_input for kw in ['æ”¾é‡', 'æˆäº¤é‡çªç ´', 'é‡èƒ½çªç ´']):
            intent['indicators'].append('volume_breakout')
            intent['conditions'].append('æ”¾é‡çªç ´')
        
        if any(kw in user_input for kw in ['çªç ´', 'æ–°é«˜', 'åˆ›æ–°é«˜']):
            intent['indicators'].append('price_breakout')
            intent['conditions'].append('ä»·æ ¼çªç ´')
        
        if any(kw in user_input for kw in ['å¸ƒæ—ä¸‹è½¨', 'BOLLä¸‹è½¨', 'ä¸‹è½¨']):
            intent['indicators'].append('boll_lower')
            intent['conditions'].append('è§¦åŠå¸ƒæ—ä¸‹è½¨')
        
        if any(kw in user_input for kw in ['å¸ƒæ—ä¸Šè½¨', 'BOLLä¸Šè½¨', 'ä¸Šè½¨']):
            intent['indicators'].append('boll_upper')
            intent['conditions'].append('è§¦åŠå¸ƒæ—ä¸Šè½¨')
        
        return intent
    
    def generate_pinescript(self, stock_code: str, stock_name: str, intent: Dict[str, Any]) -> str:
        """ç”ŸæˆPineScriptè„šæœ¬"""
        conditions = intent.get('conditions', [])
        indicators = intent.get('indicators', [])
        timeframe = intent.get('timeframe', 'daily')
        
        # æ—¶é—´å‘¨æœŸæ˜ å°„
        tf_map = {
            'daily': 'D',
            'weekly': 'W',
            'monthly': 'M',
            '5min': '5',
            '15min': '15',
            '30min': '30',
            '60min': '60',
        }
        tf = tf_map.get(timeframe, 'D')
        
        script = f'''// @version=5
// è‚¡ç¥¨ç›‘æ§è„šæœ¬ - {stock_name}({stock_code})
// ç›‘æ§æ¡ä»¶: {', '.join(conditions) if conditions else 'è‡ªå®šä¹‰æ¡ä»¶'}
// ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

indicator("{stock_name}ç›‘æ§æé†’", overlay=true)

// å‚æ•°è®¾ç½®
ma_short = input.int(5, "çŸ­æœŸå‡çº¿å‘¨æœŸ")
ma_long = input.int(20, "é•¿æœŸå‡çº¿å‘¨æœŸ")
rsi_period = input.int(14, "RSIå‘¨æœŸ")
rsi_oversold = input.int(30, "RSIè¶…å–é˜ˆå€¼")
rsi_overbought = input.int(70, "RSIè¶…ä¹°é˜ˆå€¼")

// è®¡ç®—æŒ‡æ ‡
ma5 = ta.sma(close, ma_short)
ma20 = ta.sma(close, ma_long)
rsi = ta.rsi(close, rsi_period)
[macd_line, signal_line, hist] = ta.macd(close, 12, 26, 9)
[k, d, j] = ta.kdj(high, low, close, 9, 3, 3)

// å¸ƒæ—å¸¦
[bb_middle, bb_upper, bb_lower] = ta.bb(close, 20, 2)

// æˆäº¤é‡å‡çº¿
vol_ma20 = ta.sma(volume, 20)

'''
        
        # æ·»åŠ æ¡ä»¶æ£€æµ‹
        alert_conditions = []
        
        if 'golden_cross' in indicators:
            script += '''
// å‡çº¿é‡‘å‰æ£€æµ‹
golden_cross = ta.crossover(ma5, ma20)
plotshape(golden_cross, title="é‡‘å‰", location=location.belowbar, 
          color=color.green, style=shape.triangleup, size=size.small)
'''
            alert_conditions.append('golden_cross')
        
        if 'death_cross' in indicators:
            script += '''
// å‡çº¿æ­»å‰æ£€æµ‹
death_cross = ta.crossunder(ma5, ma20)
plotshape(death_cross, title="æ­»å‰", location=location.abovebar, 
          color=color.red, style=shape.triangledown, size=size.small)
'''
            alert_conditions.append('death_cross')
        
        if 'macd_golden_cross' in indicators:
            script += '''
// MACDé‡‘å‰æ£€æµ‹
macd_golden = ta.crossover(macd_line, signal_line)
plotshape(macd_golden, title="MACDé‡‘å‰", location=location.belowbar, 
          color=color.lime, style=shape.diamond, size=size.small)
'''
            alert_conditions.append('macd_golden')
        
        if 'macd_death_cross' in indicators:
            script += '''
// MACDæ­»å‰æ£€æµ‹
macd_death = ta.crossunder(macd_line, signal_line)
plotshape(macd_death, title="MACDæ­»å‰", location=location.abovebar, 
          color=color.orange, style=shape.diamond, size=size.small)
'''
            alert_conditions.append('macd_death')
        
        if 'rsi_oversold' in indicators:
            script += '''
// RSIè¶…å–æ£€æµ‹
rsi_oversold_signal = ta.crossunder(rsi, rsi_oversold)
plotshape(rsi_oversold_signal, title="RSIè¶…å–", location=location.belowbar, 
          color=color.blue, style=shape.circle, size=size.small)
'''
            alert_conditions.append('rsi_oversold_signal')
        
        if 'rsi_overbought' in indicators:
            script += '''
// RSIè¶…ä¹°æ£€æµ‹
rsi_overbought_signal = ta.crossover(rsi, rsi_overbought)
plotshape(rsi_overbought_signal, title="RSIè¶…ä¹°", location=location.abovebar, 
          color=color.purple, style=shape.circle, size=size.small)
'''
            alert_conditions.append('rsi_overbought_signal')
        
        if 'kdj_golden_cross' in indicators:
            script += '''
// KDJé‡‘å‰æ£€æµ‹
kdj_golden = ta.crossover(k, d)
plotshape(kdj_golden, title="KDJé‡‘å‰", location=location.belowbar, 
          color=color.teal, style=shape.arrowup, size=size.small)
'''
            alert_conditions.append('kdj_golden')
        
        if 'volume_breakout' in indicators:
            script += '''
// æ”¾é‡çªç ´æ£€æµ‹
vol_breakout = volume > vol_ma20 * 2
plotshape(vol_breakout, title="æ”¾é‡", location=location.belowbar, 
          color=color.yellow, style=shape.flag, size=size.small)
'''
            alert_conditions.append('vol_breakout')
        
        if 'price_breakout' in indicators:
            script += '''
// ä»·æ ¼çªç ´æ£€æµ‹
highest_20 = ta.highest(high, 20)[1]
price_breakout = close > highest_20
plotshape(price_breakout, title="çªç ´æ–°é«˜", location=location.abovebar, 
          color=color.fuchsia, style=shape.star, size=size.small)
'''
            alert_conditions.append('price_breakout')
        
        if 'boll_lower' in indicators:
            script += '''
// è§¦åŠå¸ƒæ—ä¸‹è½¨æ£€æµ‹
touch_boll_lower = close <= bb_lower
plotshape(touch_boll_lower, title="è§¦åŠä¸‹è½¨", location=location.belowbar, 
          color=color.aqua, style=shape.xcross, size=size.small)
'''
            alert_conditions.append('touch_boll_lower')
        
        if 'boll_upper' in indicators:
            script += '''
// è§¦åŠå¸ƒæ—ä¸Šè½¨æ£€æµ‹
touch_boll_upper = close >= bb_upper
plotshape(touch_boll_upper, title="è§¦åŠä¸Šè½¨", location=location.abovebar, 
          color=color.maroon, style=shape.xcross, size=size.small)
'''
            alert_conditions.append('touch_boll_upper')
        
        # æ·»åŠ ç»˜å›¾
        script += '''
// ç»˜åˆ¶å‡çº¿
plot(ma5, "MA5", color=color.yellow, linewidth=1)
plot(ma20, "MA20", color=color.blue, linewidth=1)

// ç»˜åˆ¶å¸ƒæ—å¸¦
plot(bb_upper, "BOLLä¸Šè½¨", color=color.gray, linewidth=1)
plot(bb_middle, "BOLLä¸­è½¨", color=color.gray, linewidth=1)
plot(bb_lower, "BOLLä¸‹è½¨", color=color.gray, linewidth=1)
'''
        
        # æ·»åŠ è­¦æŠ¥æ¡ä»¶
        if alert_conditions:
            combined_condition = ' or '.join(alert_conditions)
            script += f'''
// ç»¼åˆè­¦æŠ¥æ¡ä»¶
alert_condition = {combined_condition}
alertcondition(alert_condition, title="{stock_name}ç›‘æ§æé†’", 
               message="{stock_name}({stock_code})è§¦å‘ç›‘æ§æ¡ä»¶ï¼")
'''
        
        return script
    
    def generate_python_script(self, stock_code: str, stock_name: str, intent: Dict[str, Any]) -> str:
        """ç”ŸæˆPythonç›‘æ§è„šæœ¬"""
        conditions = intent.get('conditions', [])
        indicators = intent.get('indicators', [])
        timeframe = intent.get('timeframe', 'daily')
        
        script = f'''"""
è‚¡ç¥¨ç›‘æ§è„šæœ¬ - {stock_name}({stock_code})
ç›‘æ§æ¡ä»¶: {', '.join(conditions) if conditions else 'è‡ªå®šä¹‰æ¡ä»¶'}
ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# è‚¡ç¥¨ä¿¡æ¯
STOCK_CODE = "{stock_code}"
STOCK_NAME = "{stock_name}"
TIMEFRAME = "{timeframe}"

# å‚æ•°é…ç½®
MA_SHORT = 5
MA_LONG = 20
RSI_PERIOD = 14
RSI_OVERSOLD = 30
RSI_OVERBOUGHT = 70
MACD_FAST = 12
MACD_SLOW = 26
MACD_SIGNAL = 9
KDJ_N = 9
KDJ_M1 = 3
KDJ_M2 = 3
BOLL_PERIOD = 20
BOLL_STD = 2


def calculate_ma(data: pd.DataFrame, period: int) -> pd.Series:
    """è®¡ç®—ç§»åŠ¨å¹³å‡çº¿"""
    return data['close'].rolling(window=period).mean()


def calculate_rsi(data: pd.DataFrame, period: int = 14) -> pd.Series:
    """è®¡ç®—RSIæŒ‡æ ‡"""
    delta = data['close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    return 100 - (100 / (1 + rs))


def calculate_macd(data: pd.DataFrame, fast: int = 12, slow: int = 26, signal: int = 9):
    """è®¡ç®—MACDæŒ‡æ ‡"""
    exp1 = data['close'].ewm(span=fast, adjust=False).mean()
    exp2 = data['close'].ewm(span=slow, adjust=False).mean()
    macd = exp1 - exp2
    signal_line = macd.ewm(span=signal, adjust=False).mean()
    histogram = macd - signal_line
    return macd, signal_line, histogram


def calculate_kdj(data: pd.DataFrame, n: int = 9, m1: int = 3, m2: int = 3):
    """è®¡ç®—KDJæŒ‡æ ‡"""
    low_n = data['low'].rolling(window=n).min()
    high_n = data['high'].rolling(window=n).max()
    rsv = (data['close'] - low_n) / (high_n - low_n) * 100
    k = rsv.ewm(com=m1-1, adjust=False).mean()
    d = k.ewm(com=m2-1, adjust=False).mean()
    j = 3 * k - 2 * d
    return k, d, j


def calculate_boll(data: pd.DataFrame, period: int = 20, std_dev: int = 2):
    """è®¡ç®—å¸ƒæ—å¸¦"""
    middle = data['close'].rolling(window=period).mean()
    std = data['close'].rolling(window=period).std()
    upper = middle + std_dev * std
    lower = middle - std_dev * std
    return upper, middle, lower


def check_conditions(data: pd.DataFrame) -> dict:
    """æ£€æŸ¥ç›‘æ§æ¡ä»¶"""
    if len(data) < 30:
        return {{"triggered": False, "message": "æ•°æ®ä¸è¶³"}}
    
    # è®¡ç®—æŒ‡æ ‡
    data['ma_short'] = calculate_ma(data, MA_SHORT)
    data['ma_long'] = calculate_ma(data, MA_LONG)
    data['rsi'] = calculate_rsi(data, RSI_PERIOD)
    data['macd'], data['signal'], data['hist'] = calculate_macd(data, MACD_FAST, MACD_SLOW, MACD_SIGNAL)
    data['k'], data['d'], data['j'] = calculate_kdj(data, KDJ_N, KDJ_M1, KDJ_M2)
    data['boll_upper'], data['boll_middle'], data['boll_lower'] = calculate_boll(data, BOLL_PERIOD, BOLL_STD)
    data['vol_ma20'] = data['volume'].rolling(window=20).mean()
    
    # è·å–æœ€æ–°æ•°æ®
    latest = data.iloc[-1]
    prev = data.iloc[-2]
    
    alerts = []
'''
        
        # æ·»åŠ æ¡ä»¶æ£€æµ‹
        if 'golden_cross' in indicators:
            script += '''
    # å‡çº¿é‡‘å‰æ£€æµ‹
    if latest['ma_short'] > latest['ma_long'] and prev['ma_short'] <= prev['ma_long']:
        alerts.append("ğŸ“ˆ å‡çº¿é‡‘å‰ï¼šMA5ä¸Šç©¿MA20")
'''
        
        if 'death_cross' in indicators:
            script += '''
    # å‡çº¿æ­»å‰æ£€æµ‹
    if latest['ma_short'] < latest['ma_long'] and prev['ma_short'] >= prev['ma_long']:
        alerts.append("ğŸ“‰ å‡çº¿æ­»å‰ï¼šMA5ä¸‹ç©¿MA20")
'''
        
        if 'macd_golden_cross' in indicators:
            script += '''
    # MACDé‡‘å‰æ£€æµ‹
    if latest['macd'] > latest['signal'] and prev['macd'] <= prev['signal']:
        alerts.append("ğŸ“ˆ MACDé‡‘å‰ï¼šMACDçº¿ä¸Šç©¿ä¿¡å·çº¿")
'''
        
        if 'macd_death_cross' in indicators:
            script += '''
    # MACDæ­»å‰æ£€æµ‹
    if latest['macd'] < latest['signal'] and prev['macd'] >= prev['signal']:
        alerts.append("ğŸ“‰ MACDæ­»å‰ï¼šMACDçº¿ä¸‹ç©¿ä¿¡å·çº¿")
'''
        
        if 'rsi_oversold' in indicators:
            script += '''
    # RSIè¶…å–æ£€æµ‹
    if latest['rsi'] < RSI_OVERSOLD:
        alerts.append(f"ğŸ”µ RSIè¶…å–ï¼šå½“å‰RSI={latest['rsi']:.2f}")
'''
        
        if 'rsi_overbought' in indicators:
            script += '''
    # RSIè¶…ä¹°æ£€æµ‹
    if latest['rsi'] > RSI_OVERBOUGHT:
        alerts.append(f"ğŸ”´ RSIè¶…ä¹°ï¼šå½“å‰RSI={latest['rsi']:.2f}")
'''
        
        if 'kdj_golden_cross' in indicators:
            script += '''
    # KDJé‡‘å‰æ£€æµ‹
    if latest['k'] > latest['d'] and prev['k'] <= prev['d']:
        alerts.append("ğŸ“ˆ KDJé‡‘å‰ï¼šKçº¿ä¸Šç©¿Dçº¿")
'''
        
        if 'volume_breakout' in indicators:
            script += '''
    # æ”¾é‡çªç ´æ£€æµ‹
    if latest['volume'] > latest['vol_ma20'] * 2:
        alerts.append(f"ğŸ“Š æ”¾é‡çªç ´ï¼šæˆäº¤é‡æ˜¯20æ—¥å‡é‡çš„{latest['volume']/latest['vol_ma20']:.1f}å€")
'''
        
        if 'price_breakout' in indicators:
            script += '''
    # ä»·æ ¼çªç ´æ£€æµ‹
    highest_20 = data['high'].iloc[-21:-1].max()
    if latest['close'] > highest_20:
        alerts.append(f"ğŸš€ ä»·æ ¼çªç ´ï¼šçªç ´20æ—¥é«˜ç‚¹{highest_20:.2f}")
'''
        
        if 'boll_lower' in indicators:
            script += '''
    # è§¦åŠå¸ƒæ—ä¸‹è½¨æ£€æµ‹
    if latest['close'] <= latest['boll_lower']:
        alerts.append(f"ğŸ”µ è§¦åŠå¸ƒæ—ä¸‹è½¨ï¼š{latest['boll_lower']:.2f}")
'''
        
        if 'boll_upper' in indicators:
            script += '''
    # è§¦åŠå¸ƒæ—ä¸Šè½¨æ£€æµ‹
    if latest['close'] >= latest['boll_upper']:
        alerts.append(f"ğŸ”´ è§¦åŠå¸ƒæ—ä¸Šè½¨ï¼š{latest['boll_upper']:.2f}")
'''
        
        script += '''
    return {
        "triggered": len(alerts) > 0,
        "alerts": alerts,
        "stock_code": STOCK_CODE,
        "stock_name": STOCK_NAME,
        "latest_price": latest['close'],
        "check_time": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        "indicators": {
            "ma_short": latest['ma_short'],
            "ma_long": latest['ma_long'],
            "rsi": latest['rsi'],
            "macd": latest['macd'],
            "signal": latest['signal'],
            "k": latest['k'],
            "d": latest['d'],
        }
    }


def run_monitor(data: pd.DataFrame) -> dict:
    """è¿è¡Œç›‘æ§"""
    result = check_conditions(data)
    
    if result["triggered"]:
        print(f"\\n{'='*50}")
        print(f"ğŸ”” {STOCK_NAME}({STOCK_CODE}) è§¦å‘ç›‘æ§æ¡ä»¶ï¼")
        print(f"æ—¶é—´: {result['check_time']}")
        print(f"æœ€æ–°ä»·: {result['latest_price']:.2f}")
        print(f"{'='*50}")
        for alert in result["alerts"]:
            print(f"  {alert}")
        print(f"{'='*50}\\n")
    
    return result


if __name__ == "__main__":
    # ç¤ºä¾‹ï¼šåŠ è½½æ•°æ®å¹¶è¿è¡Œç›‘æ§
    # data = pd.read_csv("stock_data.csv")
    # result = run_monitor(data)
    print(f"ç›‘æ§è„šæœ¬å·²ç”Ÿæˆ: {STOCK_NAME}({STOCK_CODE})")
    print(f"ç›‘æ§æ¡ä»¶: {", ".join({repr(c) for c in {repr(conditions)}})}") 
'''
        
        return script
    
    def create_monitor(self, stock_code: str, stock_name: str, user_input: str, 
                      script_type: str = 'python') -> Dict[str, Any]:
        """åˆ›å»ºç›‘æ§ä»»åŠ¡"""
        # è§£æç”¨æˆ·æ„å›¾
        intent = self.parse_user_intent(user_input)
        
        # ç”Ÿæˆè„šæœ¬
        if script_type == 'pinescript':
            script = self.generate_pinescript(stock_code, stock_name, intent)
        else:
            script = self.generate_python_script(stock_code, stock_name, intent)
        
        # åˆ›å»ºç›‘æ§ä»»åŠ¡
        monitor_id = f"{stock_code}_{datetime.now().strftime('%Y%m%d%H%M%S')}"
        monitor = {
            'id': monitor_id,
            'stock_code': stock_code,
            'stock_name': stock_name,
            'user_input': user_input,
            'intent': intent,
            'script_type': script_type,
            'script': script,
            'status': 'pending',  # pending, active, triggered, stopped
            'created_at': datetime.now().isoformat(),
            'last_check': None,
            'trigger_count': 0,
        }
        
        return monitor
    
    def activate_monitor(self, monitor_id: str, monitor: Dict) -> bool:
        """æ¿€æ´»ç›‘æ§ä»»åŠ¡"""
        self.active_monitors[monitor_id] = monitor
        monitor['status'] = 'active'
        logger.info(f"Monitor activated: {monitor_id}")
        return True
    
    def deactivate_monitor(self, monitor_id: str) -> bool:
        """åœæ­¢ç›‘æ§ä»»åŠ¡"""
        if monitor_id in self.active_monitors:
            self.active_monitors[monitor_id]['status'] = 'stopped'
            del self.active_monitors[monitor_id]
            logger.info(f"Monitor deactivated: {monitor_id}")
            return True
        return False
    
    def get_active_monitors(self) -> List[Dict]:
        """è·å–æ‰€æœ‰æ´»è·ƒçš„ç›‘æ§ä»»åŠ¡"""
        return list(self.active_monitors.values())
    
    def check_monitor(self, monitor_id: str, kline_data: List[Dict]) -> Optional[Dict]:
        """æ£€æŸ¥ç›‘æ§æ¡ä»¶æ˜¯å¦è§¦å‘"""
        if monitor_id not in self.active_monitors:
            return None
        
        monitor = self.active_monitors[monitor_id]
        intent = monitor.get('intent', {})
        indicators = intent.get('indicators', [])
        
        if len(kline_data) < 30:
            return None
        
        # è½¬æ¢æ•°æ®æ ¼å¼
        latest = kline_data[-1]
        prev = kline_data[-2] if len(kline_data) > 1 else latest
        
        # è®¡ç®—ç®€å•æŒ‡æ ‡
        closes = [d.get('close', 0) for d in kline_data]
        ma5 = sum(closes[-5:]) / 5 if len(closes) >= 5 else closes[-1]
        ma20 = sum(closes[-20:]) / 20 if len(closes) >= 20 else closes[-1]
        
        prev_closes = closes[:-1] if len(closes) > 1 else closes
        prev_ma5 = sum(prev_closes[-5:]) / 5 if len(prev_closes) >= 5 else prev_closes[-1]
        prev_ma20 = sum(prev_closes[-20:]) / 20 if len(prev_closes) >= 20 else prev_closes[-1]
        
        alerts = []
        
        # æ£€æŸ¥å„ç§æ¡ä»¶
        if 'golden_cross' in indicators:
            if ma5 > ma20 and prev_ma5 <= prev_ma20:
                alerts.append({
                    'type': 'golden_cross',
                    'message': f'ğŸ“ˆ å‡çº¿é‡‘å‰ï¼šMA5({ma5:.2f})ä¸Šç©¿MA20({ma20:.2f})',
                    'severity': 'high',
                })
        
        if 'death_cross' in indicators:
            if ma5 < ma20 and prev_ma5 >= prev_ma20:
                alerts.append({
                    'type': 'death_cross',
                    'message': f'ğŸ“‰ å‡çº¿æ­»å‰ï¼šMA5({ma5:.2f})ä¸‹ç©¿MA20({ma20:.2f})',
                    'severity': 'high',
                })
        
        # æ›´æ–°ç›‘æ§çŠ¶æ€
        monitor['last_check'] = datetime.now().isoformat()
        
        if alerts:
            monitor['trigger_count'] += 1
            monitor['status'] = 'triggered'
            return {
                'monitor_id': monitor_id,
                'stock_code': monitor['stock_code'],
                'stock_name': monitor['stock_name'],
                'alerts': alerts,
                'triggered_at': datetime.now().isoformat(),
                'latest_price': latest.get('close', 0),
            }
        
        return None


# åˆ›å»ºæœåŠ¡å®ä¾‹
script_service = ScriptService()